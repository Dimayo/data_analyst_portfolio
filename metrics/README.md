# Анализ поведения пользователей веб-сайта

`sql`

## Цель проекта

Целью проекта является анализ поведения пользователей на веб-сайте, включая их взаимодействие с поисковыми запросами и действиями на страницах сайта (такими как клики на товары, добавление в корзину и завершение покупки). На основании этих данных будут предложены ключевые метрики, которые помогут оценить эффективность работы сайта, удобство навигации и качество поисковых запросов. Методы расчёта и визуализация позволят отслеживать динамику изменений, выявлять узкие места и улучшать пользовательский опыт, а также принимать обоснованные решения для оптимизации процессов взаимодействия с сайтом.

## Описание проекта

Проект использует две таблицы с данными, хранящимися в базе данных ClickHouse:

### Таблица `Searches`

Эта таблица содержит данные о поисковых событиях на сайте. Вот описание каждого столбца:

- **timestamp**: Дата и время события.
- **remoteHost**: IP-адрес или хост пользователя, с которого поступил запрос.
- **location**: Текущий URL, где произошло событие.
- **referer**: URL-источник, откуда пользователь перешел.
- **regionId**: Идентификатор региона пользователя.
- **channel**: Тип браузера.
- **eventType**: Тип события (поисковый запрос).
- **sessionId**: Уникальный идентификатор сессии.
- **userId**: Уникальный идентификатор пользователя.
- **userGUID**: GUID пользователя (генерируется, например, при установке приложения).
- **viewGUID**: Уникальный GUID для конкретного просмотра/экрана/страницы.
- **pageNumber**: Номер страницы (например, для пагинации результатов поиска).
- **searchTerm**: Поисковый запрос, введенный пользователем.
- **pageProducts**: Список товаров, отображенных на текущей странице.
- **searchWorked**: Признак, указывающий, сработал ли поисковый движок.
- **synonymsWorked**: Признак, указывающий, сработала ли функция синонимов в поиске.
- **originalSearchTerm**: Исходный поисковый запрос пользователя (до применения автокоррекции и т. д.).
- **isFromRedirect**: Признак, указывающий, был ли редирект на конкретную страницу после поиска.
- **isZeroQuery**: Признак «нулевого» запроса, когда пользователь не вводил ключевых слов.

### Таблица `WidgetClicks`

Эта таблица содержит данные о действиях пользователей на сайте, таких как клики на товары, добавление в корзину и другие взаимодействия. Вот описание каждого столбца:

- **timestamp**: Временная метка события (в часовом поясе Europe/Moscow).
- **remoteHost**: IP-адрес или доменное имя клиента, с которого поступил запрос.
- **location**: Текущий URL.
- **referer**: URL-источник (Referer), откуда пользователь перешел.
- **regionId**: Идентификатор региона пользователя (или сессии), если используется региональная сегментация.
- **channel**: Тип браузера.
- **eventType**: Тип события (клик, просмотр, покупка, переход и т. д.).
- **sessionId**: Уникальный идентификатор сессии.
- **userGUID**: GUID пользователя (генерируется, например, при установке приложения или при первой сессии на сайте).
- **viewGUID**: Уникальный GUID для конкретного просмотра/экрана/страницы (может использоваться для трассировки шагов в сессии).
- **pageNumber**: Номер страницы (например, при пагинации результатов поиска или списка товаров).
- **productId**: Идентификатор конкретного продукта (если событие связано с просмотром/кликом на товар).
- **position**: Позиция товара или элемента на странице (например, в списке результатов).
- **widgetType**: Тип виджета/блока, в котором отображается контент (например, рекомендации, баннер и т. д.).

Эти данные позволяют отслеживать поведение пользователей на разных этапах их взаимодействия с сайтом, начиная от поисковых запросов и заканчивая совершением покупок.

## Результат

Для анализа событий поисковых запросов и кликов на сайтах, предлагаю следующие метрики и способы их расчета с использованием SQL, Python и BI-систем. Я приведу несколько примеров метрик и способов их реализации, а также предложу варианты визуализации.

### Метрики для анализа поисковых событий

#### Количество уникальных пользователей

**Описание:** Количество уникальных пользователей, которые выполнили хотя бы одно поисковое событие за определенный период времени.

**Расчет в SQL:**

```sql
SELECT COUNT(DISTINCT userId) AS unique_users
FROM Searches
WHERE timestamp BETWEEN '2024-01-01' AND '2024-12-31';
```

**Визуализация:** Индикатор со спарклайном для визуализации количества уникальных пользователей.

---

#### Среднее количество поисковых запросов на одного пользователя

**Описание:** Сколько в среднем поисковых запросов делает каждый уникальный пользователь за определённый период.

**Расчет в SQL:**

```sql
WITH UserSearches AS (
    SELECT userId, COUNT(*) AS total_searches
    FROM Searches
    WHERE timestamp BETWEEN '2024-01-01' AND '2024-12-31'
    GROUP BY userId
)
SELECT AVG(total_searches) AS avg_searches_per_user
FROM UserSearches;
```

**Визуализация:** Столбчатая диаграмма с количеством поисковых запросов на одного пользователя за разные периоды.

---

#### Топ поисковых запросов

**Описание:** Список наиболее популярных поисковых запросов среди всех пользователей.

**Расчет в SQL:**

```sql
SELECT searchTerm, COUNT(*) AS frequency
FROM Searches
WHERE timestamp BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY searchTerm
ORDER BY frequency DESC
LIMIT 10;
```

**Визуализация:** Древовидная диаграмма с топ-10 поисковых запросов.

---

#### Доля успешных поисков

**Описание:** Процент поисковых запросов, которые дали результат (т.е., `searchWorked` = true).

**Расчет в SQL:**

```sql
SELECT SUM(CASE WHEN searchWorked THEN 1 ELSE 0 END) / COUNT(*) * 100 AS success_rate
FROM Searches
WHERE timestamp BETWEEN '2024-01-01' AND '2024-12-31';
```

**Визуализация:** Линейный график с динамикой доли успешных поисков по дням.

---

#### Распределение поисковых запросов по регионам

**Описание:** Географическое распределение поисковых запросов.

**Расчет в SQL:**

```sql
SELECT regionId, COUNT(*) AS num_searches
FROM Searches
WHERE timestamp BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY regionId
ORDER BY num_searches DESC;
```

**Визуализация:** Карта мира с цветовой шкалой, показывающей интенсивность поисковых запросов по регионам.

---

#### Доля поисковых сессий, приведших к покупке

**Описание:** Это процент всех поисковых сессий, которые закончились завершением заказа.
**Расчет в SQL:**

```sql
WITH SearchSessions AS (
  SELECT sessionId
  FROM Searches
  WHERE eventType = 'search'
), PurchaseSessions AS (
  SELECT sessionId
  FROM WidgetClicks
  WHERE eventType = 'order_click'
)
SELECT COUNT(DISTINCT ps.sessionId) / COUNT(DISTINCT ss.sessionId) AS purchase_conversion_rate
FROM SearchSessions ss
LEFT JOIN PurchaseSessions ps ON ss.sessionId = ps.sessionId;
```

**Визуализация:** Нормированная столбчатая диаграмма с конверсией поисковых сессий по месяцам.

---

#### Популярные поисковые запросы, приводящие к покупкам

**Описание:** Какие поисковые термины чаще всего приводят к завершению покупок?
**Расчет в SQL:**

```sql
WITH SuccessfulSearches AS (
  SELECT s.searchTerm, w.eventType
  FROM Searches s
  INNER JOIN WidgetClicks w ON s.sessionId = w.sessionId
  WHERE w.eventType = 'order_click'
)
SELECT searchTerm, COUNT(*) AS purchases
FROM SuccessfulSearches
WHERE eventType = 'order_click'
GROUP BY searchTerm
ORDER BY purchases DESC
```

**Визуализация:** Визуализация в виде таблицы с запросом и количеством покупок.

---

### Метрики для анализа кликов на сайтах

#### Конверсия кликов на товары в добавление в корзину

**Описание:** Доля кликов на товары, которые привели к добавлению этих товаров в корзину. Таким же образом рассчитывается конверсия из добавления в корзину в завершение оплаты.

**Расчет в SQL:**

```sql
WITH ProductClicks AS (
    SELECT sessionId, productId
    FROM WidgetClicks
    WHERE eventType = 'product_click'
      AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
),
CartAddEvents AS (
    SELECT sessionId, productId
    FROM WidgetClicks
    WHERE eventType = 'card_add_event'
      AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
)
SELECT COUNT(DISTINCT CartAddEvents.sessionId) / COUNT(DISTINCT ProductClicks.sessionId) * 100 AS conversion_rate
FROM ProductClicks
LEFT JOIN CartAddEvents ON ProductClicks.sessionId = CartAddEvents.sessionId AND ProductClicks.productId = CartAddEvents.productId;
```

**Визуализация:** Линейный график с конверсией по дням или столбчатая диаграмма с конверсиями по продуктам.

---

#### Время до завершения покупки

**Описание:** Среднее время между первым кликом на товар и завершением оплаты.

**Расчет в SQL:**

```sql
WITH FirstProductClick AS (
    SELECT sessionId, MIN(timestamp) AS first_click_time
    FROM WidgetClicks
    WHERE eventType IN ('product_click', 'order_click')
      AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
    GROUP BY sessionId
),
OrderCompletion AS (
    SELECT sessionId, MAX(timestamp) AS last_order_click_time
    FROM WidgetClicks
    WHERE eventType = 'order_click'
      AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
    GROUP BY sessionId
)
SELECT AVG(DATEDIFF(second, FirstProductClick.first_click_time, OrderCompletion.last_order_click_time)) AS average_time_to_purchase
FROM FirstProductClick
JOIN OrderCompletion ON FirstProductClick.sessionId = OrderCompletion.sessionId;
```

**Визуализация:** Гистограмма распределения времени до завершения покупки.

---

#### Популярные продукты

**Описание:** Список самых часто кликаемых продуктов.

**Расчет в SQL:**

```sql
SELECT productId, COUNT(*) AS click_count
FROM WidgetClicks
WHERE eventType = 'product_click'
  AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY productId
ORDER BY click_count DESC
LIMIT 10;
```

**Визуализация:** Горизонтальная столбчатая диаграмма с топ-10 популярных продуктов.

---

#### Коэффициент отказов корзины

**Описание:** Доля сессий, где пользователи добавили товары в корзину, но не завершили покупку.

**Расчет в SQL:**

```sql
WITH CartAddSessions AS (
    SELECT DISTINCT sessionId
    FROM WidgetClicks
    WHERE eventType = 'card_add_event'
      AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
),
CompletedOrders AS (
    SELECT DISTINCT sessionId
    FROM WidgetClicks
    WHERE eventType = 'order_click'
      AND timestamp BETWEEN '2024-01-01' AND '2024-12-31'
)
SELECT (COUNT(DISTINCT CartAddSessions.sessionId) - COUNT(DISTINCT CompletedOrders.sessionId)) / COUNT(DISTINCT CartAddSessions.sessionId) * 100 AS cart_abandonment_rate
FROM CartAddSessions
LEFT JOIN CompletedOrders ON CartAddSessions.sessionId = CompletedOrders.sessionId;
```

**Визуализация:** Линейный график с коэффициентом отказов корзины по дням.

---

#### Динамика количества кликов по типу события

**Описание:** Изменение числа кликов каждого типа события со временем.

**Расчет в SQL:**

```sql
SELECT DATE(timestamp) AS date, eventType, COUNT(*) AS count
FROM WidgetClicks
WHERE timestamp BETWEEN '2024-01-01' AND '2024-12-31'
GROUP BY DATE(timestamp), eventType
ORDER BY date, eventType;
```

**Визуализация:** Многослойный линейный график с динамикой количества кликов разных типов событий.

## Вывод

Результаты анализа данных могут дать важные выводы о поведении пользователей, эффективности поисковых систем и успешности маркетинговых кампаний. Вот некоторые ключевые моменты, которые можно извлечь из представленных выше метрик:

- Активность пользователей: Анализ уникальности пользователей позволяет оценить, насколько сайт привлекает новых посетителей и удерживает существующих. Если число уникальных пользователей растет, это может свидетельствовать об улучшении видимости сайта или увеличении интереса к предлагаемым услугам.
- Эффективность поиска: Доля успешных поисков показывает, насколько хорошо работает поисковая система. Высокие показатели указывают на то, что большинство запросов приводят к релевантным результатам, тогда как низкие значения могут сигнализировать о необходимости улучшения алгоритмов поиска.
- Интересы аудитории: Топ поисковых запросов помогает понять, какие темы и продукты интересуют пользователей больше всего. Это знание полезно для оптимизации контента и рекламных предложений.
- Географическая активность: Распределение поисковых запросов по регионам дает представление о том, где находятся ваши основные клиенты. Эти данные могут быть использованы для таргетированной рекламы и локальных акций.
- Поведение на сайте: Коэффициенты конверсии кликов на товары в добавления в корзину и коэффициент отказа от корзин показывают, насколько эффективно работают механизмы привлечения клиентов к покупке. Низкий коэффициент конверсии может указывать на проблемы с юзабилити или необходимостью пересмотра стратегии предложения товаров.
- Скорость принятия решения: Время до завершения покупки демонстрирует, сколько времени требуется пользователям для принятия решения о покупке. Длительное время может означать необходимость упрощения процесса оформления заказа.
- Популярность продуктов: Анализ популярности отдельных продуктов помогает определить, какие товары пользуются наибольшим спросом у покупателей. Эта информация полезна для планирования ассортимента и проведения акций.
- Динамика поведения: Графики изменения количества кликов различных типов событий позволяют отслеживать тенденции в поведении пользователей и реагировать на них оперативно.
На основании этих выводов можно разработать стратегию улучшения работы сайта, повышения конверсии и увеличения продаж.
